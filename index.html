<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ãƒ•ã‚©ãƒ«ãƒ€ä»˜ããƒ¡ãƒ¢å¸³ï¼ˆæš—å·åŒ–ä¿å­˜ / IndexedDBï¼‰</title>
<style>
  :root{
    --bg:#0f1115; --panel:#151a22; --panel2:#1a2130; --acc:#2b87ff; --text:#e8eef9;
    --muted:#9fb0c3; --danger:#ff5d6c; --ok:#5bd1b7; --border:#263248; --hover:#22304a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text); font:14px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN","Noto Sans JP", Meiryo, sans-serif;
    display:flex; flex-direction:column; min-height:100%;
  }
  header{
    display:flex; align-items:center; gap:.5rem; padding:.6rem .8rem; background:var(--panel); border-bottom:1px solid var(--border);
  }
  header h1{font-size:16px; margin:0; font-weight:600; letter-spacing:.2px}
  header .spacer{flex:1}
  .btn{
    appearance:none; border:1px solid var(--border); background:var(--panel2); color:var(--text);
    border-radius:8px; padding:.45rem .7rem; cursor:pointer; transition:.15s ease;
  }
  .btn:hover{background:var(--hover)}
  .btn.primary{border-color:transparent; background:var(--acc); color:white}
  .btn.danger{border-color:transparent; background:var(--danger); color:white}
  .btn.ghost{background:transparent}
  .badge{font-size:12px; color:var(--muted)}
  .layout{
    display:grid; grid-template-columns: 240px 280px 1fr; gap:10px; padding:10px; flex:1; min-height:0;
  }
  .panel{
    background:var(--panel); border:1px solid var(--border); border-radius:12px; min-height:0; display:flex; flex-direction:column;
  }
  .panel h2{
    font-size:13px; letter-spacing:.2px; color:var(--muted);
    margin:0; padding:.7rem .8rem; border-bottom:1px solid var(--border);
  }
  .panel .toolbar{
    padding:.5rem .6rem; display:flex; gap:.4rem; border-bottom:1px dashed var(--border);
  }
  .panel .content{padding:.4rem; overflow:auto; min-height:0}
  .list{list-style:none; padding:0; margin:0}
  .item{
    display:flex; align-items:center; gap:.4rem; padding:.45rem .5rem .45rem .6rem; border-radius:10px; border:1px solid transparent;
    user-select:none;
  }
  .item:hover{background:var(--hover)}
  .item.active{background:#1d2a45; border-color:#2a3b62}
  .item .name{
    flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; cursor:pointer;
  }
  .item .actions{display:flex; gap:.2rem; align-items:center}
  .handle{
    cursor:grab; border:none; background:transparent; color:var(--muted); font-size:18px; line-height:1; padding:.1rem .2rem; margin-left:.1rem;
  }
  .handle:active{cursor:grabbing}
  .icon-btn{
    cursor:pointer; border:none; background:transparent; color:var(--muted); padding:.15rem .25rem; border-radius:6px;
  }
  .icon-btn:hover{background:rgba(255,255,255,.05); color:var(--text)}
  .reorder-list{min-height:24px}
  .dragging{opacity:.6}
  /* ã‚¨ãƒ‡ã‚£ã‚¿ */
  .editor{
    display:flex; flex-direction:column; min-height:0;
  }
  .field{
    padding:.6rem .8rem; border-bottom:1px dashed var(--border); display:flex; gap:.6rem; align-items:center;
  }
  .field input[type="text"]{
    flex:1; font-size:16px; padding:.5rem .6rem; border-radius:8px;
    border:1px solid var(--border); background:var(--panel2); color:var(--text);
  }
  .editor textarea{
    flex:1; width:100%; border:none; outline:none; resize:none; padding:12px 14px; background:transparent; color:var(--text); font-size:14px; line-height:1.6;
  }
  .muted{color:var(--muted)}
  .timestamp{font-size:12px; color:var(--muted)}
  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:50;
  }
  .modal{background:var(--panel); border:1px solid var(--border); border-radius:12px; width:min(560px, 92vw); padding:16px}
  .modal h3{margin:.2rem 0 .8rem}
  .modal .row{display:flex; gap:.5rem; margin:.5rem 0}
  .modal input[type="password"], .modal input[type="file"]{
    flex:1; padding:.5rem .6rem; border-radius:8px; border:1px solid var(--border); background:var(--panel2); color:var(--text);
  }
  .modal .hint{font-size:12px; color:var(--muted)}
  .hidden{display:none}
  /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
  ::-webkit-scrollbar{height:10px; width:10px}
  ::-webkit-scrollbar-thumb{background:#27334e; border-radius:10px}
  ::-webkit-scrollbar-track{background:#141a24}
  /* å°ã•ã‚ç”»é¢ */
  @media (max-width: 900px){
    .layout{grid-template-columns: 1fr; grid-auto-rows:minmax(200px, auto)}
    .panel{min-height:220px}
  }
</style>
</head>
<body>
  <header>
    <h1>ãƒ•ã‚©ãƒ«ãƒ€ä»˜ããƒ¡ãƒ¢å¸³</h1>
    <span class="badge" id="saveStatus">æœªä¿å­˜</span>
    <div class="spacer"></div>
    <button class="btn" id="lockBtn" title="ãƒ­ãƒƒã‚¯/ãƒ­ãƒƒã‚¯è§£é™¤">ğŸ” ãƒ­ãƒƒã‚¯</button>
    <button class="btn" id="saveBtn" title="ã™ãä¿å­˜">ğŸ’¾ ä¿å­˜</button>
    <button class="btn" id="exportBtn" title="æš—å·åŒ–ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">â¤“ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button class="btn" id="importBtn" title="æš—å·åŒ–ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ">â¤’ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
  </header>

  <main class="layout">
    <!-- ãƒ•ã‚©ãƒ«ãƒ€ -->
    <section class="panel" id="foldersPanel">
      <h2>ãƒ•ã‚©ãƒ«ãƒ€</h2>
      <div class="toolbar">
        <button class="btn primary" id="addFolderBtn">ï¼‹ ãƒ•ã‚©ãƒ«ãƒ€</button>
      </div>
      <div class="content">
        <ul id="folderList" class="list reorder-list" data-type="folder"></ul>
      </div>
    </section>

    <!-- ãƒãƒ¼ãƒˆä¸€è¦§ -->
    <section class="panel" id="notesPanel">
      <h2>ãƒãƒ¼ãƒˆ</h2>
      <div class="toolbar">
        <button class="btn primary" id="addNoteBtn">ï¼‹ ãƒãƒ¼ãƒˆ</button>
        <input id="searchNotes" class="btn ghost" style="flex:1; text-align:left" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰" />
      </div>
      <div class="content">
        <ul id="noteList" class="list reorder-list" data-type="note"></ul>
      </div>
    </section>

    <!-- ã‚¨ãƒ‡ã‚£ã‚¿ -->
    <section class="panel editor" id="editorPanel">
      <h2>ã‚¨ãƒ‡ã‚£ã‚¿</h2>
      <div class="field">
        <label class="muted">ã‚¿ã‚¤ãƒˆãƒ«</label>
        <input type="text" id="noteTitle" placeholder="ç„¡é¡Œã®ãƒãƒ¼ãƒˆ" />
        <span class="timestamp" id="timestamps"></span>
      </div>
      <textarea id="noteBody" placeholder="ã“ã“ã«æœ¬æ–‡ã‚’å…¥åŠ›â€¦"></textarea>
    </section>
  </main>

  <!-- åˆæœŸè¨­å®š / ãƒ­ãƒƒã‚¯è§£é™¤ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-backdrop" id="authModal">
    <div class="modal">
      <h3 id="authTitle">ãƒ­ãƒƒã‚¯è§£é™¤</h3>
      <div id="firstSetup" class="hidden">
        <div class="hint">åˆå›åˆ©ç”¨ã®ãŸã‚ã€ä¿å­˜æ™‚ã«ä½¿ç”¨ã™ã‚‹<strong>ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º</strong>ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼ˆå¿˜ã‚Œã‚‹ã¨å¾©å…ƒã§ãã¾ã›ã‚“ï¼‰ã€‚</div>
        <div class="row"><input type="password" id="newPass1" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º" autocomplete="new-password"></div>
        <div class="row"><input type="password" id="newPass2" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºï¼ˆç¢ºèªï¼‰" autocomplete="new-password"></div>
        <div class="row" style="justify-content:flex-end; gap:.5rem">
          <button class="btn" id="setupCancel">é–‰ã˜ã‚‹</button>
          <button class="btn primary" id="setupOk">è¨­å®šã™ã‚‹</button>
        </div>
      </div>
      <div id="unlockArea" class="hidden">
        <div class="row"><input type="password" id="passphrase" placeholder="ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º" autocomplete="current-password"></div>
        <div class="row" style="justify-content:flex-end; gap:.5rem">
          <button class="btn" id="unlockCancel">é–‰ã˜ã‚‹</button>
          <button class="btn primary" id="unlockOk">ãƒ­ãƒƒã‚¯è§£é™¤</button>
        </div>
        <div class="hint">â€» ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºãŒä¸€è‡´ã—ãªã„å ´åˆã¯å¾©å·ã«å¤±æ•—ã—ã¾ã™ã€‚</div>
      </div>
    </div>
  </div>

  <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-backdrop" id="importModal">
    <div class="modal">
      <h3>ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆæš—å·åŒ–ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—JSONï¼‰</h3>
      <div class="row"><input type="file" id="importFile" accept="application/json"></div>
      <div class="row"><input type="password" id="importPass" placeholder="ã“ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º"></div>
      <div class="row" style="justify-content:flex-end; gap:.5rem">
        <button class="btn" id="importCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn primary" id="importOk">èª­ã¿è¾¼ã‚€</button>
      </div>
      <div class="hint">èª­ã¿è¾¼ã‚€ã¨ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚</div>
    </div>
  </div>

<script>
/* =========================
   ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« / ã‚¢ãƒ—ãƒªçŠ¶æ…‹
   ========================= */
const DB_NAME = 'MemoFoldersDB';
const STORE = 'vault';
const VAULT_ID = 'main';
const KDF_ITERATIONS = 200000; // PBKDF2
const ENC_VERSION = 1;

let appState = null;       // å¾©å·æ¸ˆã¿çŠ¶æ…‹ {folders:[], selectedFolderId, selectedNoteId, ...}
let derivedKey = null;     // SubtleCrypto CryptoKeyï¼ˆãƒ¡ãƒ¢ãƒªä¿æŒã®ã¿ï¼‰
let currentSalt = null;    // Uint8Array
let isUnlocked = false;
let autoSaveTimer = null;

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

/* ================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   ================ */
const enc = new TextEncoder();
const dec = new TextDecoder();

function now(){return Date.now()}
function fmt(ts){
  if(!ts) return '';
  const d=new Date(ts);
  const z=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`;
}
function uuid(){ return (crypto.randomUUID ? crypto.randomUUID() : 'id-' + Math.random().toString(36).slice(2) + Date.now()) }
function markDirty(){
  $('#saveStatus').textContent = 'æœªä¿å­˜â€¦';
}
function markSaved(){
  $('#saveStatus').textContent = 'ä¿å­˜æ¸ˆ ' + fmt(now());
}
function debounceSave(){
  markDirty();
  if(autoSaveTimer) clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(()=>saveVault().catch(console.error), 600);
}
function ensureUnlocked(){
  if(!isUnlocked || !derivedKey) throw new Error('ãƒ­ãƒƒã‚¯è§£é™¤ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
}

/* ===================
   IndexedDB ãƒ©ãƒƒãƒ‘ãƒ¼
   =================== */
function openDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = (e)=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE, { keyPath:'id' });
      }
    };
    req.onsuccess = ()=>resolve(req.result);
    req.onerror = ()=>reject(req.error);
  });
}
async function idbGet(){
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(STORE,'readonly');
    const st = tx.objectStore(STORE);
    const req = st.get(VAULT_ID);
    req.onsuccess = ()=>resolve(req.result || null);
    req.onerror = ()=>reject(req.error);
  });
}
async function idbPut(record){
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(STORE,'readwrite');
    const st = tx.objectStore(STORE);
    const req = st.put(record);
    req.onsuccess = ()=>resolve();
    req.onerror = ()=>reject(req.error);
  });
}

/* ===================
   æš—å·ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   =================== */
function b64fromBuf(buf){
  const bytes = new Uint8Array(buf);
  let bin = '';
  for(let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]);
  return btoa(bin);
}
function bufFromB64(b64){
  const bin = atob(b64);
  const bytes = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
  return bytes.buffer;
}
async function deriveKey(passphrase, salt){
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(passphrase), 'PBKDF2', false, ['deriveKey']);
  return await crypto.subtle.deriveKey(
    { name:'PBKDF2', salt, iterations:KDF_ITERATIONS, hash:'SHA-256' },
    baseKey,
    { name:'AES-GCM', length:256 },
    false,
    ['encrypt','decrypt']
  );
}
async function encryptState(obj){
  ensureUnlocked();
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const data = enc.encode(JSON.stringify(obj));
  const ciphertext = await crypto.subtle.encrypt({name:'AES-GCM', iv}, derivedKey, data);
  return { iv_b64: b64fromBuf(iv), ct_b64: b64fromBuf(ciphertext) };
}
async function decryptState(ct_b64, iv_b64, key){
  const iv = new Uint8Array(bufFromB64(iv_b64));
  const ct = bufFromB64(ct_b64);
  const plain = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
  return JSON.parse(dec.decode(new Uint8Array(plain)));
}

/* ==================
   ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ç³»
   ================== */
function emptyState(){
  return {
    version: ENC_VERSION,
    createdAt: now(),
    lastSaved: now(),
    selectedFolderId: null,
    selectedNoteId: null,
    folders: []
  };
}
async function showAuthModal(kind){ // 'setup' | 'unlock'
  const modal = $('#authModal');
  $('#firstSetup').classList.toggle('hidden', kind!=='setup');
  $('#unlockArea').classList.toggle('hidden', kind!=='unlock');
  $('#authTitle').textContent = (kind==='setup' ? 'åˆæœŸè¨­å®šï¼ˆãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºä½œæˆï¼‰' : 'ãƒ­ãƒƒã‚¯è§£é™¤');
  modal.style.display = 'flex';
  if(kind==='setup'){
    $('#newPass1').value=''; $('#newPass2').value=''; $('#newPass1').focus();
  }else{
    $('#passphrase').value=''; $('#passphrase').focus();
  }
}
function closeAuthModal(){ $('#authModal').style.display='none' }

async function boot(){
  const rec = await idbGet();
  if(!rec){
    // åˆå›èµ·å‹•ï¼šã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—èª˜å°
    await showAuthModal('setup');
  }else{
    // ãƒ­ãƒƒã‚¯è§£é™¤ç”»é¢
    await showAuthModal('unlock');
  }
}
window.addEventListener('load', boot);

/* ==========================
   ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— / ãƒ­ãƒƒã‚¯è§£é™¤
   ========================== */
$('#setupCancel').onclick = closeAuthModal;
$('#unlockCancel').onclick = closeAuthModal;

$('#setupOk').onclick = async ()=>{
  const p1 = $('#newPass1').value.trim();
  const p2 = $('#newPass2').value.trim();
  if(p1.length<6){ alert('ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã¯6æ–‡å­—ä»¥ä¸Šã‚’æ¨å¥¨ã—ã¾ã™ã€‚'); return; }
  if(p1!==p2){ alert('ç¢ºèªå…¥åŠ›ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚'); return; }
  currentSalt = crypto.getRandomValues(new Uint8Array(16));
  derivedKey = await deriveKey(p1, currentSalt);
  isUnlocked = true;
  appState = emptyState();
  // ç©ºçŠ¶æ…‹ã‚’å³ä¿å­˜ã—ã¦ã€ŒåŸºç›¤ã€ã‚’ä½œã‚‹
  await saveVault();
  closeAuthModal();
  renderAll();
};

$('#unlockOk').onclick = async ()=>{
  const pass = $('#passphrase').value;
  const rec = await idbGet();
  if(!rec){ alert('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'); return; }
  try{
    currentSalt = new Uint8Array(bufFromB64(rec.salt_b64));
    derivedKey = await deriveKey(pass, currentSalt);
    const st = await decryptState(rec.ct_b64, rec.iv_b64, derivedKey);
    appState = st;
    isUnlocked = true;
    closeAuthModal();
    renderAll();
    markSaved();
  }catch(e){
    console.error(e);
    alert('ãƒ­ãƒƒã‚¯è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  }
};

/* ==================
   ä¿å­˜ / ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
   ================== */
async function saveVault(){
  ensureUnlocked();
  const { iv_b64, ct_b64 } = await encryptState({
    ...appState,
    version: ENC_VERSION,
    lastSaved: now()
  });
  const rec = {
    id: VAULT_ID,
    version: ENC_VERSION,
    savedAt: now(),
    iter: KDF_ITERATIONS,
    salt_b64: b64fromBuf(currentSalt),
    iv_b64,
    ct_b64
  };
  await idbPut(rec);
  markSaved();
}
$('#saveBtn').onclick = ()=>saveVault().catch(console.error);

/* ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆæš—å·åŒ–æ¸ˆã¿JSONï¼‰ */
$('#exportBtn').onclick = async ()=>{
  const rec = await idbGet();
  if(!rec){ alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }
  const blob = new Blob([JSON.stringify(rec,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.download = `SecureNotesBackup_${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
  a.href = URL.createObjectURL(blob);
  a.click();
  URL.revokeObjectURL(a.href);
};

/* ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆæš—å·åŒ–JSONï¼‰ */
$('#importBtn').onclick = ()=>{$('#importModal').style.display='flex'};
$('#importCancel').onclick = ()=>{$('#importModal').style.display='none'};
$('#importOk').onclick = async ()=>{
  try{
    const file = $('#importFile').files[0];
    const pass = $('#importPass').value;
    if(!file){ alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
    const text = await file.text();
    const rec = JSON.parse(text);
    // ã¾ãšå¾©å·ã§ãã‚‹ã‹ç¢ºèª
    const salt = new Uint8Array(bufFromB64(rec.salt_b64));
    const key = await deriveKey(pass, salt);
    await decryptState(rec.ct_b64, rec.iv_b64, key); // OKãªã‚‰æ¡ç”¨
    // ä¸Šæ›¸ãä¿å­˜
    await idbPut({ ...rec, id:VAULT_ID });
    // ãã®ã¾ã¾ãƒ­ãƒƒã‚¯è§£é™¤çŠ¶æ…‹ã¸
    currentSalt = salt; derivedKey = key; isUnlocked = true;
    appState = await decryptState(rec.ct_b64, rec.iv_b64, key);
    $('#importModal').style.display='none';
    renderAll(); markSaved();
  }catch(e){
    console.error(e);
    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
  }
};

/* ==============
   ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
   ============== */
function renderAll(){
  renderFolders();
  renderNotes();
  renderEditor();
}

function renderFolders(){
  const ul = $('#folderList'); ul.innerHTML='';
  if(!appState || !appState.folders) return;
  for(const f of appState.folders){
    const li = document.createElement('li');
    li.className = 'item' + (f.id===appState.selectedFolderId ? ' active':'');
    li.dataset.id = f.id;
    li.innerHTML = `
      <span class="name" title="ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ / ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§åå‰å¤‰æ›´">${escapeHtml(f.name||'ç„¡é¡Œãƒ•ã‚©ãƒ«ãƒ€')}</span>
      <div class="actions">
        <button class="icon-btn rename" title="åå‰å¤‰æ›´">âœï¸</button>
        <button class="icon-btn del" title="å‰Šé™¤">ğŸ—‘</button>
        <button class="handle" draggable="true" title="ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã¹æ›¿ãˆ">â˜°</button>
      </div>`;
    ul.appendChild(li);
  }
  attachFolderEvents();
}

function renderNotes(){
  const ul = $('#noteList'); ul.innerHTML='';
  const folder = appState.folders.find(f=>f.id===appState.selectedFolderId);
  const q = $('#searchNotes').value.trim().toLowerCase();
  let notes = folder ? folder.notes : [];
  if(q) notes = notes.filter(n=> (n.title||'').toLowerCase().includes(q));
  for(const n of notes){
    const li = document.createElement('li');
    li.className = 'item' + (n.id===appState.selectedNoteId ? ' active':'');
    li.dataset.id = n.id;
    li.innerHTML = `
      <span class="name" title="ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ / ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§åå‰å¤‰æ›´">${escapeHtml(n.title||'ç„¡é¡Œã®ãƒãƒ¼ãƒˆ')}</span>
      <div class="actions">
        <button class="icon-btn rename" title="åå‰å¤‰æ›´">âœï¸</button>
        <button class="icon-btn del" title="å‰Šé™¤">ğŸ—‘</button>
        <button class="handle" draggable="true" title="ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã¹æ›¿ãˆ">â˜°</button>
      </div>`;
    ul.appendChild(li);
  }
  attachNoteEvents();
}

function renderEditor(){
  const note = getCurrentNote();
  $('#noteTitle').value = note ? (note.title||'') : '';
  $('#noteBody').value = note ? (note.body||'') : '';
  $('#noteTitle').disabled = !note;
  $('#noteBody').disabled = !note;
  $('#timestamps').textContent = note ? `ä½œæˆ:${fmt(note.createdAt)} / æ›´æ–°:${fmt(note.updatedAt)}` : '';
}

/* ===========
   æ“ä½œç³»
   =========== */
$('#addFolderBtn').onclick = ()=>{
  ensureUnlocked();
  const f = { id:uuid(), name:'æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€', notes:[], createdAt:now(), updatedAt:now() };
  appState.folders.push(f);
  appState.selectedFolderId = f.id;
  appState.selectedNoteId = null;
  renderFolders(); renderNotes(); renderEditor();
  debounceSave();
};
$('#addNoteBtn').onclick = ()=>{
  ensureUnlocked();
  const folder = ensureFolderSelected();
  const n = { id:uuid(), title:'æ–°ã—ã„ãƒãƒ¼ãƒˆ', body:'', createdAt:now(), updatedAt:now() };
  folder.notes.push(n);
  appState.selectedNoteId = n.id;
  renderNotes(); renderEditor();
  debounceSave();
};
$('#searchNotes').oninput = ()=>renderNotes();

$('#noteTitle').addEventListener('input', ()=>{
  const note = getCurrentNote(); if(!note) return;
  note.title = $('#noteTitle').value; note.updatedAt=now(); renderNotes(); debounceSave();
});
$('#noteBody').addEventListener('input', ()=>{
  const note = getCurrentNote(); if(!note) return;
  note.body = $('#noteBody').value; note.updatedAt=now(); debounceSave();
});

$('#lockBtn').onclick = ()=>{
  // ãƒ­ãƒƒã‚¯ï¼ˆãƒ¡ãƒ¢ãƒªä¸Šã®éµã‚’ç ´æ£„ã—ã€UIã‚’å†æç”»ï¼‰
  derivedKey = null; isUnlocked = false; appState = null;
  // ç”»é¢ã‚¯ãƒªã‚¢
  $('#folderList').innerHTML=''; $('#noteList').innerHTML='';
  $('#noteTitle').value=''; $('#noteBody').value=''; $('#timestamps').textContent='';
  $('#saveStatus').textContent='ãƒ­ãƒƒã‚¯ä¸­';
  showAuthModal('unlock');
};

/* ã‚¯ãƒªãƒƒã‚¯/ãƒªãƒãƒ¼ãƒ /å‰Šé™¤ï¼ˆãƒ•ã‚©ãƒ«ãƒ€ï¼‰ */
function attachFolderEvents(){
  $$('#folderList .item .name').forEach(el=>{
    el.onclick = (e)=>{
      const id = e.currentTarget.closest('.item').dataset.id;
      appState.selectedFolderId = id;
      // ãƒ•ã‚©ãƒ«ãƒ€åˆ‡æ›¿æ™‚ã¯æœ€åˆã®ãƒãƒ¼ãƒˆã‚’é¸ã¶
      const folder = appState.folders.find(f=>f.id===id);
      appState.selectedNoteId = (folder && folder.notes[0]) ? folder.notes[0].id : null;
      renderFolders(); renderNotes(); renderEditor();
    };
    el.ondblclick = (e)=>inlineRename(e.currentTarget, 'folder');
  });
  $$('#folderList .item .rename').forEach(btn=>{
    btn.onclick = (e)=> inlineRename(e.currentTarget.closest('.item').querySelector('.name'), 'folder');
  });
  $$('#folderList .item .del').forEach(btn=>{
    btn.onclick = (e)=>{
      const li = e.currentTarget.closest('.item'); const id = li.dataset.id;
      const f = appState.folders.find(x=>x.id===id);
      if(!confirm(`ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${f.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆä¸­ã®ãƒãƒ¼ãƒˆã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`)) return;
      appState.folders = appState.folders.filter(x=>x.id!==id);
      if(appState.selectedFolderId===id){ appState.selectedFolderId=null; appState.selectedNoteId=null; }
      renderFolders(); renderNotes(); renderEditor(); debounceSave();
    };
  });
  makeReorderable($('#folderList'), 'folder');
}

/* ã‚¯ãƒªãƒƒã‚¯/ãƒªãƒãƒ¼ãƒ /å‰Šé™¤ï¼ˆãƒãƒ¼ãƒˆï¼‰ */
function attachNoteEvents(){
  $$('#noteList .item .name').forEach(el=>{
    el.onclick = (e)=>{
      const id = e.currentTarget.closest('.item').dataset.id;
      appState.selectedNoteId = id;
      renderNotes(); renderEditor();
    };
    el.ondblclick = (e)=>inlineRename(e.currentTarget, 'note');
  });
  $$('#noteList .item .rename').forEach(btn=>{
    btn.onclick = (e)=> inlineRename(e.currentTarget.closest('.item').querySelector('.name'), 'note');
  });
  $$('#noteList .item .del').forEach(btn=>{
    btn.onclick = (e)=>{
      const li = e.currentTarget.closest('.item'); const id = li.dataset.id;
      const folder = ensureFolderSelected();
      const n = folder.notes.find(x=>x.id===id);
      if(!confirm(`ãƒãƒ¼ãƒˆã€Œ${n.title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      folder.notes = folder.notes.filter(x=>x.id!==id);
      if(appState.selectedNoteId===id){ appState.selectedNoteId = (folder.notes[0]?.id) || null; }
      renderNotes(); renderEditor(); debounceSave();
    };
  });
  makeReorderable($('#noteList'), 'note');
}

/* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒªãƒãƒ¼ãƒ  */
function inlineRename(nameEl, type){
  const li = nameEl.closest('.item');
  const id = li.dataset.id;
  const orig = nameEl.textContent;
  const input = document.createElement('input');
  input.type = 'text'; input.value = orig; input.style.width = '100%';
  nameEl.replaceWith(input); input.focus(); input.select();
  function commit(apply){
    const val = input.value.trim();
    const span = document.createElement('span');
    span.className='name'; span.title='ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ / ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§åå‰å¤‰æ›´';
    if(apply && val){
      span.textContent = val;
      if(type==='folder'){
        const f = appState.folders.find(f=>f.id===id);
        f.name = val; f.updatedAt=now(); debounceSave();
      }else{
        const n = findNoteById(id);
        n.title = val; n.updatedAt=now(); debounceSave();
      }
    }else{
      span.textContent = orig;
    }
    span.onclick = (e)=>{
      if(type==='folder'){
        appState.selectedFolderId = id;
        const folder = appState.folders.find(f=>f.id===id);
        appState.selectedNoteId = (folder.notes[0]?.id)||null;
        renderFolders(); renderNotes(); renderEditor();
      }else{
        appState.selectedNoteId = id;
        renderNotes(); renderEditor();
      }
    };
    span.ondblclick = ()=>inlineRename(span, type);
    input.replaceWith(span);
  }
  input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter') commit(true);
    if(e.key==='Escape') commit(false);
  });
  input.addEventListener('blur', ()=>commit(true));
}

/* ===========
   ä¸¦ã¹æ›¿ãˆ
   =========== */
function makeReorderable(listEl, type){
  let draggingEl = null;
  let dragType = null;

  // å³ç«¯ã®ãƒãƒ³ãƒ‰ãƒ«ã®ã¿ draggable=trueã€‚ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã§è¦ª.itemã‚’ã€Œãƒ‰ãƒ©ãƒƒã‚°ä¸­ã€ã«ã™ã‚‹
  listEl.querySelectorAll('.handle').forEach(h=>{
    h.addEventListener('dragstart', (e)=>{
      draggingEl = e.currentTarget.closest('.item');
      dragType = type;
      draggingEl.classList.add('dragging');
      // ãƒ‰ãƒ©ãƒƒã‚°ç”»åƒã‚’è¦ç´ ã«
      const img = draggingEl.cloneNode(true);
      img.style.position='absolute'; img.style.top='-9999px'; img.style.left='-9999px'; document.body.appendChild(img);
      e.dataTransfer.setDragImage(img, img.offsetWidth-10, 10);
      setTimeout(()=>document.body.removeChild(img),0);
      e.dataTransfer.effectAllowed='move';
    });
    h.addEventListener('dragend', ()=>{
      if(!draggingEl) return;
      draggingEl.classList.remove('dragging');
      // DOMé †ã‹ã‚‰æ–°ã—ã„é †åºã‚’ä¿å­˜
      const ids = Array.from(listEl.children).map(li=>li.dataset.id);
      applyNewOrder(type, ids);
      draggingEl = null; dragType = null;
      debounceSave();
    });
  });

  listEl.addEventListener('dragover', (e)=>{
    e.preventDefault();
    if(!draggingEl || dragType!==type) return;
    const afterEl = getDragAfterElement(listEl, e.clientY);
    if(afterEl==null) listEl.appendChild(draggingEl);
    else listEl.insertBefore(draggingEl, afterEl);
  });
  listEl.addEventListener('drop', (e)=>{ e.preventDefault(); });
}

function getDragAfterElement(list, y){
  const items = [...list.querySelectorAll('.item:not(.dragging)')];
  let closest = {offset: Number.NEGATIVE_INFINITY, element: null};
  for(const child of items){
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height/2;
    if(offset < 0 && offset > closest.offset){
      closest = {offset, element:child};
    }
  }
  return closest.element;
}

function applyNewOrder(type, ids){
  if(type==='folder'){
    const map = new Map(appState.folders.map(f=>[f.id, f]));
    appState.folders = ids.map(id=>map.get(id)).filter(Boolean);
    renderFolders();
  }else{
    const folder = ensureFolderSelected();
    const map = new Map(folder.notes.map(n=>[n.id,n]));
    folder.notes = ids.map(id=>map.get(id)).filter(Boolean);
    renderNotes();
  }
}

/* ===========
   å–å¾—ç³»
   =========== */
function ensureFolderSelected(){
  let folder = appState.folders.find(f=>f.id===appState.selectedFolderId);
  if(!folder && appState.folders[0]){
    folder = appState.folders[0];
    appState.selectedFolderId = folder.id;
  }
  return folder;
}
function getCurrentNote(){
  const f = ensureFolderSelected(); if(!f) return null;
  let note = f.notes.find(n=>n.id===appState.selectedNoteId);
  if(!note && f.notes[0]){ note = f.notes[0]; appState.selectedNoteId = note.id; }
  return note||null;
}
function findNoteById(id){
  for(const f of appState.folders){
    const n = f.notes.find(x=>x.id===id);
    if(n) return n;
  }
  return null;
}

/* ===========
   HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
   =========== */
function escapeHtml(s){
  return (s??'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}
</script>
</body>
</html>
